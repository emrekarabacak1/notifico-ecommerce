@model Notifico.ViewModels.CheckoutViewModel

@{
    ViewData["Title"] = "Siparişi Onayla";
}

<style>
    .checkout-main-card {
        max-width: 900px;
        margin: 36px auto 0 auto;
        background: #fff;
        border-radius: 22px;
        box-shadow: 0 3px 26px 0 rgba(51,71,120,0.09);
        padding: 2.2rem 2.7rem 2.5rem 2.7rem;
    }
    .checkout-title {
        font-size: 2rem;
        font-weight: 800;
        color: #1a2a5c;
        letter-spacing: -0.02em;
        margin-bottom: 2.4rem;
    }

    .checkout-address-list {
        gap: 1.1rem;
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 1.3rem;
    }
    .address-card-select {
        border: 2px solid #d5e1f8;
        background: #f8fafd;
        border-radius: 14px;
        padding: 1.2rem 1.3rem 1rem 1.3rem;
        cursor: pointer;
        position: relative;
        transition: border 0.15s, box-shadow 0.12s;
        min-width: 270px;
        max-width: 340px;
        flex: 1 1 250px;
        box-shadow: 0 1px 6px 0 rgba(50,100,180,0.06);
        margin-bottom: 12px;
    }
    .address-card-select.selected {
        border: 2.2px solid #2171eb;
        background: #eef4fd;
        box-shadow: 0 2px 15px 0 rgba(45,120,255,0.10);
    }
    .address-card-select .selected-tick {
        position: absolute;
        top: 11px;
        right: 17px;
        display: none;
    }
    .address-card-select.selected .selected-tick {
        display: block;
    }
    .address-card-content { min-height: 44px; }
    .address-add-link {
        margin-top: 0.9rem; display:inline-block; font-size:1rem; color: #2563eb; text-decoration: underline;
    }
    .address-card-select .badge-default {
        color: #fff; background: #2171eb; font-size: 0.92rem; border-radius: 7px; padding: 0.18rem 0.7rem; margin-left: 0.5rem;
    }

    .checkout-section {
        margin-bottom: 2.2rem;
    }
    .checkout-card {
        border-radius: 13px;
        background: #f8fafd;
        box-shadow: 0 2px 10px 0 rgba(40,80,160,0.05);
        padding: 1.1rem 1.45rem 1.3rem 1.45rem;
        margin-bottom: 1.6rem;
    }
    .checkout-table {
        background: #fff;
        border-radius: 13px;
        box-shadow: 0 2px 14px 0 rgba(60,110,180,0.06);
    }
    .checkout-table th {
        background: #f4f8ff;
        color: #193d71;
        font-weight: 700;
        font-size: 1.04rem;
        border-bottom: 2px solid #e9f0fc;
    }
    .checkout-table td {
        vertical-align: middle;
        font-size: 1.05rem;
    }
    .checkout-total-box {
        background: #ecf2fa;
        border-radius: 8px;
        padding: 1.1rem 2.1rem;
        font-size: 1.2rem;
        font-weight: 700;
        color: #153265;
        text-align: right;
        margin-top: 1.1rem;
    }
    .checkout-btn {
        margin-top: 2.1rem;
        display: block;
        width: 100%;
        max-width: 310px;
        margin-left: auto;
        margin-right: 0;
        padding: 1rem 0;
        border-radius: 15px;
        background: #2563eb;
        color: #fff;
        font-size: 1.17rem;
        font-weight: 700;
        border: none;
        transition: background .15s;
        box-shadow: 0 1px 9px 0 rgba(47,101,208,0.08);
    }
    .checkout-btn:disabled {
        background: #b7c6e6;
        color: #fff;
        cursor: not-allowed;
    }
    media (max-width: 900px) {
        .checkout-main-card { padding: 1.3rem 0.7rem 2.3rem 0.7rem; }
        .checkout-address-list { flex-direction: column; }
    }
    media (max-width: 600px) {
        .checkout-title { font-size: 1.24rem;}
        .checkout-main-card { padding: 1.1rem 0.2rem 1.6rem 0.2rem; }
        .checkout-total-box { font-size: 1rem; }
    }
</style>

<div class="checkout-main-card">
    <div class="checkout-title">Siparişi Onayla</div>
    <form asp-action="Checkout" method="post">

        <div class="checkout-section">
            <label class="form-label mb-2" style="font-weight:700;color:#1a365d;">Teslimat Adresi</label>
            @if (Model.Addresses != null && Model.Addresses.Any())
            {
                <div class="checkout-address-list" id="addressCardsArea">
                    @foreach (var addr in Model.Addresses)
                    {
                        var isSelected = Model.SelectedAddressId == addr.Id;
                        <div class="address-card-select @(isSelected ? "selected" : "")" onclick="selectAddress(@addr.Id)">
                            <input type="radio" name="SelectedAddressId" id="addressRadio_@addr.Id"
                                value="@addr.Id" style="display:none;" @(isSelected ? "checked" : "") />
                            <div class="address-card-content">
                                <div style="font-weight:700;color:#1a2a5c;">
                                    @addr.Title
                                    @if (addr.IsDefault)
                                    {
                                        <span class="badge-default">Varsayılan</span>
                                    }
                                </div>
                                <div style="color:#1b2335;">@addr.FullAddress</div>
                                <div style="font-size:0.98rem;color:#7a8ca6;">
                                    @addr.District, @addr.City @addr.ZipCode
                                </div>
                            </div>
                            <span class="selected-tick">
                                <svg width="22" height="22" fill="none"><circle cx="11" cy="11" r="11" fill="#2563eb" opacity="0.16"/><path d="M7 11.6l2.4 2.4L15 8.8" stroke="#2171eb" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </span>
                        </div>
                    }
                </div>
                <span asp-validation-for="SelectedAddressId" class="text-danger"></span>
            }
            else
            {
                <div class="alert alert-warning mb-2">
                    Sipariş verebilmek için adres eklemelisiniz.
                </div>
            }
            <a href="/Address/Add" class="address-add-link">+ Yeni Adres Ekle</a>
        </div>

        <div class="checkout-section">
            <div class="checkout-table">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Ürün</th>
                            <th>Adet</th>
                            <th>Fiyat</th>
                            <th>Toplam</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.CartItems)
                        {
                            <tr>
                                <td>@item.Product?.Name</td>
                                <td>@item.Quantity</td>
                                <td>@(item.Product != null ? $"{item.Product.Price:C}" : "-")</td>
                                <td>@(item.Product != null ? (item.Quantity * item.Product.Price).ToString("C") : "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="checkout-total-box">
            Toplam: @Model.CartItems.Sum(x => (x.Product?.Price ?? 0) * x.Quantity).ToString("C")
        </div>
        <button type="submit" class="checkout-btn" @(Model.Addresses == null || !Model.Addresses.Any() ? "disabled" : "")>
            <i class="bi bi-check2-circle"></i> Siparişi Tamamla
        </button>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        function selectAddress(id) {
            document.querySelectorAll('.address-card-select').forEach(function (el) {
                el.classList.remove('selected');
            });
            var card = document.querySelector('.address-card-select input[value="' + id + '"]').parentElement;
            card.classList.add('selected');
            document.getElementById('addressRadio_' + id).checked = true;
        }
        document.addEventListener("DOMContentLoaded", function () {
            var checked = document.querySelector('.address-card-select input[type="radio"]:checked');
            if (checked) checked.parentElement.classList.add('selected');
        });

        $(function () {
            @if (TempData["Error"] != null)
            {
                <text>
                    toastr.error("@TempData["Error"]", "Hata", { timeOut: 3000 });
                </text>
            }
            @if (TempData["OrderSuccess"] != null)
            {
                <text>
                    toastr.success("@TempData["OrderSuccess"]", "Başarılı", { timeOut: 2500 });
                </text>
            }
        });
    </script>
}
